<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <title>DocuSafely</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
        }

        input,
        textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        /* Platform-specific fonts from roadmap */
        :root {
            --font-mac: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-windows: 'Segoe UI', Tahoma, Arial, sans-serif;
            --font-default: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-default);
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
            overflow: hidden;
            margin: 0;
            height: 100vh;
        }

        body[data-theme="dark"] {
            background: #1e1e1e;
            color: #fff;
        }

        /* macOS vibrancy effect */
        body[data-platform="darwin"] {
            background: transparent;
        }

        body[data-platform="darwin"] .panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        body[data-platform="darwin"][data-theme="dark"] .panel {
            background: rgba(30, 30, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Windows/Linux solid panels */
        body[data-platform="win32"] .panel,
        body[data-platform="linux"] .panel {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        body[data-platform="win32"][data-theme="dark"] .panel,
        body[data-platform="linux"][data-theme="dark"] .panel {
            background: #2b2b2b;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
        }

        .panel {
            width: 100%;
            flex: 1;
            padding: 30px;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            flex-direction: column;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
        }

        .subtitle {
            font-size: 13px;
            text-align: center;
            margin-bottom: 24px;
            opacity: 0.7;
        }

        /* File drag and drop area */
        .file-drop-zone {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0, 0, 0, 0.02);
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-drop-zone:hover {
            border-color: #007acc;
            background: rgba(0, 122, 204, 0.05);
        }

        .file-drop-zone.drag-over {
            border-color: #007acc;
            background: rgba(0, 122, 204, 0.1);
            border-style: solid;
        }

        .file-drop-zone .drop-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .file-drop-zone .drop-text {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .file-drop-zone .drop-hint {
            font-size: 13px;
            opacity: 0.6;
        }

        /* File selected display */
        .file-drop-zone.has-file .drop-icon,
        .file-drop-zone.has-file .drop-text,
        .file-drop-zone.has-file .drop-hint {
            display: none;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .file-item-name {
            font-size: 14px;
            font-weight: 500;
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-item-remove {
            width: 24px;
            height: 24px;
            min-width: 24px;
            background: rgba(220, 53, 69, 0.15);
            color: #dc3545;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: all 0.2s ease;
        }

        .file-item-remove:hover {
            background: rgba(220, 53, 69, 0.3);
        }

        body[data-theme="dark"] .file-item-remove {
            background: rgba(220, 53, 69, 0.2);
        }

        body[data-theme="dark"] .file-item-remove:hover {
            background: rgba(220, 53, 69, 0.4);
        }

        /* macOS specific drag and drop */
        body[data-platform="darwin"] .file-drop-zone {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        body[data-platform="darwin"][data-theme="dark"] .file-drop-zone {
            background: rgba(30, 30, 30, 0.6);
        }

        body[data-theme="dark"] .file-drop-zone {
            background: rgba(43, 43, 43, 0.5);
            border-color: #5b5b5b;
        }

        body[data-theme="dark"] .file-drop-zone:hover {
            border-color: #007acc;
            background: rgba(0, 122, 204, 0.15);
        }

        body[data-theme="dark"] .file-drop-zone.drag-over {
            border-color: #007acc;
            background: rgba(0, 122, 204, 0.2);
        }

        input[type="file"] {
            display: none;
        }

        /* Buttons */
        button {
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .browse-btn {
            padding: 12px 24px;
            background: #007acc;
            color: white;
            white-space: nowrap;
            border-radius: 8px;
        }

        .browse-btn:hover {
            background: #005a9e;
        }

        .process-btn {
            width: 100%;
            padding: 10px 16px;
            font-size: 15px;
            font-weight: 600;
            background: #007acc;
            color: white;
            margin-bottom: 16px;
        }

        .process-btn:disabled {
            cursor: not-allowed;
        }

        /* macOS native button styling */
        body[data-platform="darwin"] .process-btn {
            background: #007AFF;
            border-radius: 5px;
            padding: 8px 24px;
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 0.01em;
        }

        body[data-platform="darwin"] .process-btn:hover:not(:disabled) {
            background: #0051D5;
        }

        body[data-platform="darwin"] .process-btn:active:not(:disabled) {
            background: #0051D5;
        }

        body[data-platform="darwin"][data-theme="dark"] .process-btn {
            background: #0A84FF;
        }

        body[data-platform="darwin"][data-theme="dark"] .process-btn:hover:not(:disabled) {
            background: #409CFF;
        }

        body[data-platform="darwin"][data-theme="dark"] .process-btn:active:not(:disabled) {
            background: #0051D5;
        }

        body[data-platform="darwin"] .process-btn:disabled {
            background: #8E8E93;
            opacity: 0.4;
        }

        /* Windows native button styling */
        body[data-platform="win32"] .process-btn {
            border-radius: 4px;
            padding: 8px 24px;
            font-size: 14px;
            background: #0078D4;
            font-weight: 400;
        }

        body[data-platform="win32"] .process-btn:hover:not(:disabled) {
            background: #005A9E;
        }

        body[data-platform="win32"] .process-btn:active:not(:disabled) {
            background: #004578;
        }

        body[data-platform="win32"][data-theme="dark"] .process-btn {
            background: #0078D4;
        }

        body[data-platform="win32"][data-theme="dark"] .process-btn:hover:not(:disabled) {
            background: #0066C0;
        }

        body[data-platform="win32"] .process-btn:disabled {
            background: #D2D2D2;
            color: #9E9E9E;
        }

        body[data-platform="win32"][data-theme="dark"] .process-btn:disabled {
            background: #3F3F3F;
            color: #6E6E6E;
        }

        /* Linux native button styling */
        body[data-platform="linux"] .process-btn {
            border-radius: 5px;
            padding: 8px 24px;
            font-size: 14px;
            background: #007ACC;
            font-weight: 400;
        }

        body[data-platform="linux"] .process-btn:hover:not(:disabled) {
            background: #005A9E;
        }

        body[data-platform="linux"] .process-btn:active:not(:disabled) {
            background: #004080;
        }

        body[data-platform="linux"][data-theme="dark"] .process-btn {
            background: #0066CC;
        }

        body[data-platform="linux"][data-theme="dark"] .process-btn:hover:not(:disabled) {
            background: #007ACC;
        }

        body[data-platform="linux"] .process-btn:disabled {
            background: #A0A0A0;
            cursor: not-allowed;
        }

        body[data-platform="linux"][data-theme="dark"] .process-btn:disabled {
            background: #4A4A4A;
            color: #8A8A8A;
        }

        /* Success state - green button */
        .process-btn.success {
            background: #28a745 !important;
        }

        .process-btn.success:hover:not(:disabled) {
            background: #218838 !important;
        }

        body[data-platform="darwin"] .process-btn.success {
            background: #34C759 !important;
        }

        body[data-platform="darwin"] .process-btn.success:hover:not(:disabled) {
            background: #30D158 !important;
        }

        body[data-platform="darwin"][data-theme="dark"] .process-btn.success {
            background: #30D158 !important;
        }

        body[data-platform="darwin"][data-theme="dark"] .process-btn.success:hover:not(:disabled) {
            background: #34C759 !important;
        }

        body[data-platform="win32"] .process-btn.success {
            background: #107C10 !important;
        }

        body[data-platform="win32"] .process-btn.success:hover:not(:disabled) {
            background: #0E6E0E !important;
        }

        body[data-platform="win32"][data-theme="dark"] .process-btn.success {
            background: #0E6E0E !important;
        }

        body[data-platform="win32"][data-theme="dark"] .process-btn.success:hover:not(:disabled) {
            background: #107C10 !important;
        }

        body[data-platform="linux"] .process-btn.success {
            background: #28a745 !important;
        }

        body[data-platform="linux"] .process-btn.success:hover:not(:disabled) {
            background: #218838 !important;
        }

        body[data-platform="linux"][data-theme="dark"] .process-btn.success {
            background: #30D158 !important;
        }

        body[data-platform="linux"][data-theme="dark"] .process-btn.success:hover:not(:disabled) {
            background: #34C759 !important;
        }

        /* Processing Overlay */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            flex-direction: column;
            gap: 24px;
            pointer-events: all;
            cursor: wait;
        }

        .processing-overlay.active {
            display: flex;
        }

        .processing-content {
            background: white;
            border-radius: 12px;
            padding: 32px 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            min-width: 320px;
            text-align: center;
        }

        body[data-theme="dark"] .processing-content {
            background: #2b2b2b;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .processing-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        body[data-theme="dark"] .processing-title {
            color: #fff;
        }

        .processing-progress-container {
            width: 100%;
            height: 24px;
            background: #e5e5e5;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin-bottom: 12px;
        }

        body[data-theme="dark"] .processing-progress-container {
            background: #4b4b4b;
        }

        .processing-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg,
                    #007acc 0%,
                    #007acc 50%,
                    #0099ff 50%,
                    #0099ff 100%);
            background-size: 200% 100%;
            border-radius: 12px;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        /* Zebra/striped animation */
        .processing-progress-bar.animating {
            animation: zebra-stripe 1.5s linear infinite;
        }

        @keyframes zebra-stripe {
            0% {
                background-position: 0% 0%;
            }

            100% {
                background-position: 200% 0%;
            }
        }

        /* Zebra stripes overlay - more visible animation */
        .processing-progress-bar.animating::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(45deg,
                    rgba(255, 255, 255, 0) 0px,
                    rgba(255, 255, 255, 0) 8px,
                    rgba(255, 255, 255, 0.25) 8px,
                    rgba(255, 255, 255, 0.25) 16px);
            background-size: 32px 32px;
            animation: stripe-move 0.6s linear infinite;
            pointer-events: none;
        }

        @keyframes stripe-move {
            0% {
                background-position: 0 0;
            }

            100% {
                background-position: 32px 32px;
            }
        }

        .processing-status-text {
            font-size: 13px;
            color: #666;
            margin-top: 8px;
        }

        body[data-theme="dark"] .processing-status-text {
            color: #aaa;
        }

        /* Error Alert Popup */
        .error-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            pointer-events: all;
        }

        .error-alert-overlay.active {
            display: flex;
        }

        .error-alert-popup {
            background: white;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            min-width: 400px;
            max-width: 500px;
            overflow: hidden;
        }

        body[data-theme="dark"] .error-alert-popup {
            background: #2b2b2b;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        body[data-platform="darwin"] .error-alert-popup {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        body[data-platform="darwin"][data-theme="dark"] .error-alert-popup {
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .error-alert-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        body[data-theme="dark"] .error-alert-header {
            border-bottom-color: rgba(255, 255, 255, 0.15);
        }

        .error-alert-icon {
            font-size: 24px;
            color: #dc3545;
        }

        .error-alert-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        body[data-theme="dark"] .error-alert-title {
            color: #fff;
        }

        .error-alert-body {
            padding: 20px 24px;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        body[data-theme="dark"] .error-alert-body {
            color: #ccc;
        }

        .error-alert-footer {
            padding: 16px 24px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        body[data-theme="dark"] .error-alert-footer {
            border-top-color: rgba(255, 255, 255, 0.15);
        }

        .error-alert-ok-btn {
            padding: 8px 24px;
            font-size: 14px;
            font-weight: 500;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .error-alert-ok-btn:hover {
            background: #005a9e;
        }

        body[data-platform="darwin"] .error-alert-ok-btn {
            background: #007AFF;
            border-radius: 5px;
        }

        body[data-platform="darwin"] .error-alert-ok-btn:hover {
            background: #0051D5;
        }

        body[data-platform="darwin"][data-theme="dark"] .error-alert-ok-btn {
            background: #0A84FF;
        }

        body[data-platform="darwin"][data-theme="dark"] .error-alert-ok-btn:hover {
            background: #409CFF;
        }

        body[data-platform="win32"] .error-alert-ok-btn {
            background: #0078D4;
            border-radius: 4px;
        }

        body[data-platform="win32"] .error-alert-ok-btn:hover {
            background: #005A9E;
        }

        body[data-platform="linux"] .error-alert-ok-btn {
            background: #007ACC;
            border-radius: 5px;
        }

        body[data-platform="linux"] .error-alert-ok-btn:hover {
            background: #005A9E;
        }

        /* macOS native button interaction */
        body[data-platform="darwin"] button {
            transition: background-color 0.15s ease;
        }

        /* Custom title bar styling for bold "DocuSafely" */
        .cet-title {
            font-weight: 600 !important;
        }

        /* Fix titlebar container scrolling */
        .cet-container {
            overflow: hidden !important;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        body[data-theme="dark"] .tabs {
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .tab {
            padding: 8px 0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            transition: color 0.15s ease;
            color: #333;
        }

        body[data-theme="dark"] .tab {
            color: #fff;
        }

        .tab.active {
            color: #007AFF;
            border-bottom-color: #007AFF;
        }

        body[data-theme="dark"] .tab.active {
            color: #409CFF;
            border-bottom-color: #409CFF;
        }

        body[data-platform="win32"] .tab.active {
            color: #0078D4;
            border-bottom-color: #0078D4;
        }

        body[data-platform="win32"][data-theme="dark"] .tab.active {
            color: #0078D4;
            border-bottom-color: #0078D4;
        }

        .tab:not(.active) {
            opacity: 0.6;
        }

        .tab:hover:not(.active) {
            opacity: 1;
        }

        /* Policy cards */
        .policy-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .policy-card {
            padding: 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: transparent;
        }

        body[data-theme="dark"] .policy-card {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .policy-card:hover {
            border-color: #007AFF;
        }

        body[data-theme="dark"] .policy-card:hover {
            border-color: #409CFF;
        }

        .policy-card.selected {
            border-color: #007AFF;
            background: rgba(0, 122, 255, 0.05);
        }

        body[data-theme="dark"] .policy-card.selected {
            border-color: #409CFF;
            background: rgba(64, 156, 255, 0.1);
        }

        .policy-radio {
            margin: 0 8px 0 0;
            cursor: pointer;
        }

        .policy-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .policy-desc {
            font-size: 12px;
            opacity: 0.7;
        }

        /* Entities list */
        .entities-section {
            margin-bottom: 24px;
        }

        .entities-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .entities-list {
            font-size: 13px;
            opacity: 0.8;
        }

        /* Expert Options panel */
        #panel-expert {
            display: none;
        }

        .expert-entities-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 24px;
        }

        .expert-entity-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: transparent;
        }

        body[data-theme="dark"] .expert-entity-item {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .expert-entity-item:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        body[data-theme="dark"] .expert-entity-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .expert-checkbox {
            cursor: pointer;
        }

        .expert-entity-label {
            font-size: 13px;
            flex: 1;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div class="content">
            <div class="panel">
                <!-- Hidden file input -->
                <input type="file" id="hiddenFileInput" accept=".txt,.pdf" style="display: none;">

                <!-- Drag and drop zone -->
                <div class="file-drop-zone" id="dropZone">
                    <div class="drop-icon">üìÑ</div>
                    <div class="drop-text">Drop file here or click to select</div>
                </div>

                <!-- File item will be inserted here dynamically -->

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" id="tab-security">Security Level</button>
                    <button class="tab" id="tab-expert">Expert Options</button>
                </div>

                <!-- Security Level Panel -->
                <div id="panel-security">
                    <p style="font-size: 13px; margin-bottom: 16px; opacity: 0.8;">Choose a security level. Entities are
                        included automatically.</p>

                    <div class="policy-grid">
                        <div class="policy-card selected" data-level="basic">
                            <input type="radio" name="securityLevel" value="basic" class="policy-radio" checked>
                            <div>
                                <div class="policy-title">Basic</div>
                                <div class="policy-desc">Names, addresses, phone, email</div>
                            </div>
                        </div>
                        <div class="policy-card" data-level="balanced">
                            <input type="radio" name="securityLevel" value="balanced" class="policy-radio">
                            <div>
                                <div class="policy-title">Balanced</div>
                                <div class="policy-desc">Basic + SSN, credit cards, bank, driver IDs</div>
                            </div>
                        </div>
                        <div class="policy-card" data-level="strict">
                            <input type="radio" name="securityLevel" value="strict" class="policy-radio">
                            <div>
                                <div class="policy-title">Strict</div>
                                <div class="policy-desc">All entities incl. credentials, health, legal</div>
                            </div>
                        </div>
                    </div>

                    <div class="entities-section">
                        <div class="entities-title">Entities included</div>
                        <div class="entities-list" id="level-entities"></div>
                    </div>
                </div>

                <!-- Expert Options Panel -->
                <div id="panel-expert">
                    <p style="font-size: 13px; margin-bottom: 16px; opacity: 0.8;">Select individual entities to
                        process.</p>
                    <div class="expert-entities-grid" id="expert-entities"></div>
                </div>

                <button id="processBtn" class="process-btn" disabled>Process File</button>
            </div>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-content">
            <div class="processing-title">Processing Document</div>
            <div class="processing-progress-container">
                <div class="processing-progress-bar" id="processingProgressBar"></div>
            </div>
            <div class="processing-status-text" id="processingStatusText">Initializing...</div>
        </div>
    </div>

    <!-- Error Alert Popup -->
    <div class="error-alert-overlay" id="errorAlertOverlay">
        <div class="error-alert-popup">
            <div class="error-alert-header">
                <div class="error-alert-icon">‚ö†Ô∏è</div>
                <div class="error-alert-title">Error</div>
            </div>
            <div class="error-alert-body" id="errorAlertMessage"></div>
            <div class="error-alert-footer">
                <button class="error-alert-ok-btn" id="errorAlertOkBtn">OK</button>
            </div>
        </div>
    </div>

    <script>
        // UI elements (defined early for use in init)
        const dropZone = document.getElementById('dropZone');
        const hiddenFileInput = document.getElementById('hiddenFileInput');
        const processBtn = document.getElementById('processBtn');
        const processingOverlay = document.getElementById('processingOverlay');
        const processingProgressBar = document.getElementById('processingProgressBar');
        const processingStatusText = document.getElementById('processingStatusText');
        const levelEntities = document.getElementById('level-entities');
        const errorAlertOverlay = document.getElementById('errorAlertOverlay');
        const errorAlertMessage = document.getElementById('errorAlertMessage');
        const errorAlertOkBtn = document.getElementById('errorAlertOkBtn');

        // Entity catalog
        const ENTITY_CATALOG = [
            { key: 'person_name', label: 'Person Name' },
            { key: 'address', label: 'Address' },
            { key: 'phone', label: 'Phone' },
            { key: 'email', label: 'Email' },
            { key: 'postal_code', label: 'Postal Code' },
            { key: 'ssn', label: 'SSN' },
            { key: 'credit_card', label: 'Credit Card' },
            { key: 'bank_account', label: 'Bank Account' },
            { key: 'drivers_license', label: "Driver's License" },
            { key: 'credentials', label: 'Credentials/Secrets' },
            { key: 'health', label: 'Health Information' },
            { key: 'metadata', label: 'Metadata/IDs' }
        ];

        // Security levels
        const SECURITY_LEVELS = {
            basic: ['person_name', 'address', 'phone', 'email'],
            balanced: ['person_name', 'address', 'phone', 'email', 'ssn', 'credit_card', 'bank_account', 'drivers_license'],
            strict: ENTITY_CATALOG.map(e => e.key)
        };

        let selectedFilePath = '';
        let fileItemElement = null;
        let currentLevel = 'basic';
        let currentTab = 'security';
        let expertSelectedEntities = ENTITY_CATALOG.map(e => e.key); // Default to all selected
        let processedOutputPath = ''; // Store the processed file path
        let isReadyToSave = false; // Track if file is ready to save

        // Platform and theme setup
        function init() {
            if (window.electronAPI) {
                // Resize window to account for removed status banner
                // Height reduced from 650px to 600px (~50px removed)
                window.electronAPI.windowSetSize({ width: 600, height: 600 }).catch(() => {
                    // Silently fail if resize is not available
                });

                // Get platform
                window.electronAPI.getPlatform().then(platform => {
                    document.body.setAttribute('data-platform', platform);
                }).catch(() => {
                    document.body.setAttribute('data-platform', 'darwin');
                });

                // Get theme
                window.electronAPI.getTheme().then(isDark => {
                    document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
                }).catch(() => {
                    document.body.setAttribute('data-theme', 'light');
                });

                // Theme change listener
                window.electronAPI.onThemeChanged((isDark) => {
                    document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
                });

                // Menu actions
                window.electronAPI.onMenuAction(async (action) => {
                    if (action === 'open-file') {
                        try {
                            const filePath = await window.electronAPI.selectInputFile();
                            if (filePath) {
                                const ext = filePath.toLowerCase().split('.').pop();
                                if (ext !== 'txt' && ext !== 'pdf') {
                                    showErrorAlert('Please select a .txt or .pdf file');
                                    return;
                                }
                                handleFileSelect(filePath);
                            }
                        } catch (error) {
                            showErrorAlert(`Error selecting file: ${error.message}`);
                        }
                    } else if (action === 'process-document') {
                        processBtn.click();
                    }
                });
            }
        }

        // Show error alert popup
        function showErrorAlert(message) {
            errorAlertMessage.textContent = message;
            errorAlertOverlay.classList.add('active');
        }

        // Hide error alert popup
        function hideErrorAlert() {
            errorAlertOverlay.classList.remove('active');
        }

        // Close error alert when OK button is clicked
        errorAlertOkBtn.addEventListener('click', hideErrorAlert);

        // Close error alert when clicking outside the popup
        errorAlertOverlay.addEventListener('click', (e) => {
            if (e.target === errorAlertOverlay) {
                hideErrorAlert();
            }
        });

        // Show processing overlay with progress
        function showProcessingOverlay(percent, text) {
            processingProgressBar.style.width = `${Math.max(0, Math.min(100, percent))}%`;
            processingStatusText.textContent = text || 'Processing...';

            if (percent > 0 && percent < 100) {
                processingProgressBar.classList.add('animating');
            } else {
                processingProgressBar.classList.remove('animating');
            }

            processingOverlay.classList.add('active');
        }

        // Hide processing overlay
        function hideProcessingOverlay() {
            processingOverlay.classList.remove('active');
            processingProgressBar.classList.remove('animating');
            processingProgressBar.style.width = '0%';
        }

        // Render level entities
        function renderLevelEntities() {
            const entities = SECURITY_LEVELS[currentLevel].map(key => {
                const info = ENTITY_CATALOG.find(e => e.key === key);
                return info ? info.label : key;
            });
            levelEntities.textContent = entities.join(', ');
        }

        // Render expert entities
        function renderExpertEntities() {
            const expertEntitiesEl = document.getElementById('expert-entities');
            expertEntitiesEl.innerHTML = ENTITY_CATALOG.map(entity => `
                <div class="expert-entity-item" data-entity="${entity.key}">
                    <input type="checkbox" class="expert-checkbox" data-entity="${entity.key}" 
                           ${expertSelectedEntities.includes(entity.key) ? 'checked' : ''}>
                    <span class="expert-entity-label">${entity.label}</span>
                </div>
            `).join('');
        }

        // Handle file selection
        function handleFileSelect(path) {
            selectedFilePath = path;

            // Reset processed state when new file is selected
            processedOutputPath = '';
            isReadyToSave = false;
            processBtn.textContent = 'Process File';
            processBtn.classList.remove('success');

            // Extract just the filename from the path
            const fileName = path.split(/[\\/]/).pop();

            // Create file item element if it doesn't exist
            if (!fileItemElement) {
                fileItemElement = document.createElement('div');
                fileItemElement.className = 'file-item';

                const fileNameEl = document.createElement('span');
                fileNameEl.className = 'file-item-name';
                fileNameEl.textContent = fileName;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'file-item-remove';
                removeBtn.innerHTML = '‚úï';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    clearFileSelection();
                });

                fileItemElement.appendChild(fileNameEl);
                fileItemElement.appendChild(removeBtn);
                dropZone.appendChild(fileItemElement);
            } else {
                // Update existing file item
                fileItemElement.querySelector('.file-item-name').textContent = fileName;
            }

            // Hide default content and show file item
            dropZone.classList.add('has-file');
            dropZone.style.cursor = 'default';
            processBtn.disabled = false;
        }

        // Remove file selection
        function clearFileSelection() {
            selectedFilePath = '';
            processedOutputPath = '';
            isReadyToSave = false;

            // Remove file item and show default content
            if (fileItemElement) {
                fileItemElement.remove();
                fileItemElement = null;
            }

            dropZone.classList.remove('has-file');
            dropZone.style.cursor = 'pointer';
            hiddenFileInput.value = '';
            processBtn.disabled = true;
            processBtn.textContent = 'Process File';
            processBtn.classList.remove('success');
        }

        // Click to select file (only when no file is selected)
        dropZone.addEventListener('click', async () => {
            if (!selectedFilePath) {
                try {
                    const filePath = await window.electronAPI.selectInputFile();
                    if (filePath) {
                        const ext = filePath.toLowerCase().split('.').pop();
                        if (ext !== 'txt' && ext !== 'pdf') {
                            showErrorAlert('Please select a .txt or .pdf file');
                            return;
                        }
                        handleFileSelect(filePath);
                    }
                } catch (error) {
                    showErrorAlert(`Error selecting file: ${error.message}`);
                }
            }
        });

        // Handle hidden file input change (fallback - HTML file input doesn't provide full paths in Electron)
        hiddenFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const ext = file.name.toLowerCase().split('.').pop();
                if (ext !== 'txt' && ext !== 'pdf') {
                    showErrorAlert('Please select a .txt or .pdf file');
                    return;
                }
                // HTML file input doesn't provide full paths in Electron with context isolation
                // Try to use file.path if available (works in some Electron contexts)
                if (file.path) {
                    handleFileSelect(file.path);
                } else {
                    // If no path available, show error and suggest using the file picker
                    showErrorAlert('Please use the "Click to select" button or File > Open File menu to select a file.');
                    hiddenFileInput.value = ''; // Clear the input
                }
            }
        });

        // Drag and drop handlers
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');

            const file = e.dataTransfer.files[0];
            if (file) {
                const ext = file.name.toLowerCase().split('.').pop();
                if (ext !== 'txt' && ext !== 'pdf') {
                    showErrorAlert('Please select a .txt or .pdf file');
                    return;
                }

                // Try to get path directly (works in some Electron configurations)
                if (file.path) {
                    handleFileSelect(file.path);
                } else {
                    // Fallback: read file and save to temp directory via IPC
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await window.electronAPI.saveDroppedFile(file.name, Array.from(new Uint8Array(arrayBuffer)));

                        if (result.status === 'success') {
                            handleFileSelect(result.filePath);
                        } else {
                            showErrorAlert(`Error processing dropped file: ${result.message}`);
                        }
                    } catch (error) {
                        showErrorAlert(`Error reading dropped file: ${error.message}`);
                    }
                }
            }
        });

        // Policy card selection
        document.querySelectorAll('.policy-card').forEach(card => {
            card.addEventListener('click', () => {
                // Update radio button
                const radio = card.querySelector('.policy-radio');
                radio.checked = true;

                // Update current level
                currentLevel = radio.value;

                // Update card appearance
                document.querySelectorAll('.policy-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');

                // Update entities list
                renderLevelEntities();
            });
        });

        // Tab switching
        document.getElementById('tab-security').addEventListener('click', () => {
            currentTab = 'security';
            document.getElementById('tab-security').classList.add('active');
            document.getElementById('tab-expert').classList.remove('active');
            document.getElementById('panel-security').style.display = 'block';
            document.getElementById('panel-expert').style.display = 'none';
        });

        document.getElementById('tab-expert').addEventListener('click', () => {
            currentTab = 'expert';
            document.getElementById('tab-expert').classList.add('active');
            document.getElementById('tab-security').classList.remove('active');
            document.getElementById('panel-expert').style.display = 'block';
            document.getElementById('panel-security').style.display = 'none';
        });

        // Expert entity checkbox changes (delegated event listener)
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('expert-checkbox')) {
                const entityKey = e.target.dataset.entity;
                if (e.target.checked) {
                    if (!expertSelectedEntities.includes(entityKey)) {
                        expertSelectedEntities.push(entityKey);
                    }
                } else {
                    expertSelectedEntities = expertSelectedEntities.filter(key => key !== entityKey);
                }
            }
        });

        // Initialize entities display
        renderLevelEntities();
        renderExpertEntities();

        // Process file
        processBtn.addEventListener('click', async () => {
            // Handle "Save File" button click
            if (isReadyToSave) {
                try {
                    // Extract original filename and extension
                    const originalPath = selectedFilePath;
                    const pathParts = originalPath.split(/[\\/]/);
                    const originalFileName = pathParts[pathParts.length - 1];
                    const lastDotIndex = originalFileName.lastIndexOf('.');
                    const nameWithoutExt = lastDotIndex > 0
                        ? originalFileName.substring(0, lastDotIndex)
                        : originalFileName;
                    const extension = lastDotIndex > 0
                        ? originalFileName.substring(lastDotIndex)
                        : '';

                    // Create default filename: original_name_masked.ext
                    const defaultFilename = `${nameWithoutExt}_masked${extension}`;

                    // Show save dialog with default filename
                    const savePath = await window.electronAPI.selectOutputFile({ defaultFilename });

                    if (savePath) {
                        // Copy processed file to user-selected location
                        const copyResult = await window.electronAPI.copyFile(processedOutputPath, savePath, true);

                        if (copyResult.status === 'success') {
                            processBtn.classList.remove('success');
                            setTimeout(() => {
                                clearFileSelection();
                            }, 2000);
                        } else {
                            showErrorAlert(`Error saving file: ${copyResult.message}`);
                        }
                    }
                } catch (error) {
                    showErrorAlert(`Error: ${error.message}`);
                }
                return;
            }

            // Handle "Process File" button click
            if (!selectedFilePath) {
                showErrorAlert('Please select a file');
                return;
            }

            processBtn.disabled = true;
            showProcessingOverlay(10, 'Starting...');

            try {
                const policy = {
                    entities: currentTab === 'expert'
                        ? expertSelectedEntities.slice()
                        : SECURITY_LEVELS[currentLevel].slice()
                };

                showProcessingOverlay(30, 'Processing document...');
                const result = await window.electronAPI.processDocument({ inputPath: selectedFilePath, policy });

                if (result.status === 'success') {
                    showProcessingOverlay(100, 'Complete!');

                    // Store the processed output path
                    processedOutputPath = result.output || result.outputPath || '';

                    // Update button to "Save File" with green success state
                    isReadyToSave = true;
                    processBtn.textContent = 'Save File';
                    processBtn.disabled = false;
                    processBtn.classList.add('success');

                    hideProcessingOverlay();
                } else {
                    hideProcessingOverlay();
                    showErrorAlert(`Error: ${result.message}`);
                    processBtn.disabled = false;
                }
            } catch (error) {
                hideProcessingOverlay();
                showErrorAlert(`Error: ${error.message}`);
                processBtn.disabled = false;
            }
        });

        // Initialize when the DOM is ready
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>